using EndangeredNearYou.Infrastructure.Classes;
using EndangeredNearYou.Infrastructure.Services;
using FluentAssertions;
using System.Net;

namespace EndangeredNearYou.Test
{
    public class INaturalistApiIntegrationTests
    {
        [Theory]
        [InlineData(5, "Thalurania watertonii", "IUCN Red List", "en", "endangered")]
        public async Task GetObservations_SpeciesCountsAsync_Test(int expectedCount, string expectedName, string expectedAuthority, string expectedConservationStatusCode, string expectedConservationStatus)
        {
            // Arrange
            double lat = 70.99999;
            double lng = 80.7777;
            AppSettings mockAppSettings = new AppSettings();
            mockAppSettings.ApiKey = "abc123";
            var mockResponse = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new StringContent(
                "{\"total_results\":5,\"page\":1,\"per_page\":500,\"results\":[{\"count\":1,\"taxon\":{\"id\":5946,\"rank\":\"species\",\"rank_level\":10,\"iconic_taxon_id\":3,\"ancestor_ids\":[48460,1,2,355675,3,1583761,5562,1542290,1542295,5945,5946],\"is_active\":true,\"name\":\"Thalurania watertonii\",\"parent_id\":5945,\"ancestry\":\"48460/1/2/355675/3/1583761/5562/1542290/1542295/5945\",\"extinct\":false,\"default_photo\":{\"id\":73971580,\"license_code\":null,\"attribution\":\"(c) Marcelo Maux, all rights reserved, uploaded by Marcelo Maux\",\"url\":\"https://static.inaturalist.org/photos/73971580/square.jpg\",\"original_dimensions\":{\"height\":2048,\"width\":2048},\"flags\":[],\"attribution_name\":\"Marcelo Maux\",\"square_url\":\"https://static.inaturalist.org/photos/73971580/square.jpg\",\"medium_url\":\"https://static.inaturalist.org/photos/73971580/medium.jpg\"},\"taxon_changes_count\":0,\"taxon_schemes_count\":7,\"observations_count\":40,\"flag_counts\":{\"resolved\":0,\"unresolved\":0},\"current_synonymous_taxon_ids\":null,\"atlas_id\":null,\"complete_species_count\":null,\"wikipedia_url\":\"http://en.wikipedia.org/wiki/Long-tailed_woodnymph\",\"complete_rank\":\"subspecies\",\"iconic_taxon_name\":\"Aves\",\"preferred_common_name\":\"Long-tailed Woodnymph\",\"conservation_status\":{\"id\":2106,\"place_id\":null,\"source_id\":18766,\"user_id\":null,\"authority\":\"IUCN Red List\",\"status\":\"en\",\"status_name\":\"endangered\",\"geoprivacy\":\"obscured\",\"iucn\":40}}},{\"count\":1,\"taxon\":{\"id\":31876,\"rank\":\"species\",\"rank_level\":10,\"iconic_taxon_id\":26036,\"ancestor_ids\":[48460,1,2,355675,26036,26172,85552,1567777,85550,31680,31790,31876],\"is_active\":true,\"name\":\"Amphisbaena carvalhoi\",\"parent_id\":31790,\"ancestry\":\"48460/1/2/355675/26036/26172/85552/1567777/85550/31680/31790\",\"extinct\":false,\"default_photo\":{\"id\":422048411,\"license_code\":null,\"attribution\":\"(c) Raul Sales, all rights reserved, uploaded by Raul Sales\",\"url\":\"https://static.inaturalist.org/photos/422048411/square.jpeg\",\"original_dimensions\":{\"height\":1536,\"width\":2048},\"flags\":[],\"attribution_name\":\"Raul Sales\",\"square_url\":\"https://static.inaturalist.org/photos/422048411/square.jpeg\",\"medium_url\":\"https://static.inaturalist.org/photos/422048411/medium.jpeg\"},\"taxon_changes_count\":1,\"taxon_schemes_count\":2,\"observations_count\":8,\"flag_counts\":{\"resolved\":0,\"unresolved\":0},\"current_synonymous_taxon_ids\":null,\"atlas_id\":null,\"complete_species_count\":null,\"wikipedia_url\":\"http://en.wikipedia.org/wiki/Amphisbaena_carvalhoi\",\"complete_rank\":\"subspecies\",\"iconic_taxon_name\":\"Reptilia\",\"preferred_common_name\":\"Carvalho Worm Lizard\",\"conservation_status\":{\"id\":268458,\"place_id\":null,\"source_id\":null,\"user_id\":null,\"authority\":\"IUCN Red List\",\"status\":\"en\",\"status_name\":\"endangered\",\"geoprivacy\":\"obscured\",\"iucn\":40}}},{\"count\":1,\"taxon\":{\"id\":190223,\"rank\":\"species\",\"rank_level\":10,\"iconic_taxon_id\":47126,\"ancestor_ids\":[48460,47126,211194,47125,47124,47791,51816,468848,921783,1341086,184324,190223],\"is_active\":true,\"name\":\"Campomanesia aromatica\",\"parent_id\":184324,\"ancestry\":\"48460/47126/211194/47125/47124/47791/51816/468848/921783/1341086/184324\",\"extinct\":false,\"default_photo\":{\"id\":113241018,\"license_code\":\"cc-by-nc-nd\",\"attribution\":\"(c) Víctor de Paiva, some rights reserved (CC BY-NC-ND), uploaded by Víctor de Paiva\",\"url\":\"https://inaturalist-open-data.s3.amazonaws.com/photos/113241018/square.jpeg\",\"original_dimensions\":{\"height\":1536,\"width\":2048},\"flags\":[],\"attribution_name\":\"Víctor de Paiva\",\"square_url\":\"https://inaturalist-open-data.s3.amazonaws.com/photos/113241018/square.jpeg\",\"medium_url\":\"https://inaturalist-open-data.s3.amazonaws.com/photos/113241018/medium.jpeg\"},\"taxon_changes_count\":0,\"taxon_schemes_count\":3,\"observations_count\":59,\"flag_counts\":{\"resolved\":0,\"unresolved\":0},\"current_synonymous_taxon_ids\":null,\"atlas_id\":null,\"complete_species_count\":null,\"wikipedia_url\":\"http://en.wikipedia.org/wiki/Campomanesia_aromatica\",\"iconic_taxon_name\":\"Plantae\",\"conservation_status\":{\"id\":77000,\"place_id\":null,\"source_id\":9164,\"user_id\":null,\"authority\":\"IUCN Red List\",\"status\":\"vu\",\"status_name\":\"vulnerable\",\"geoprivacy\":\"obscured\",\"iucn\":30}}},{\"count\":1,\"taxon\":{\"id\":367691,\"rank\":\"species\",\"rank_level\":10,\"iconic_taxon_id\":3,\"ancestor_ids\":[48460,1,2,355675,3,7251,11989,367692,367691],\"is_active\":true,\"name\":\"Anumara forbesi\",\"parent_id\":367692,\"ancestry\":\"48460/1/2/355675/3/7251/11989/367692\",\"extinct\":false,\"default_photo\":{\"id\":30240050,\"license_code\":\"cc-by-nc\",\"attribution\":\"(c) daniesser, some rights reserved (CC BY-NC), uploaded by daniesser\",\"url\":\"https://inaturalist-open-data.s3.amazonaws.com/photos/30240050/square.jpg\",\"original_dimensions\":{\"height\":700,\"width\":980},\"flags\":[],\"attribution_name\":\"daniesser\",\"square_url\":\"https://inaturalist-open-data.s3.amazonaws.com/photos/30240050/square.jpg\",\"medium_url\":\"https://inaturalist-open-data.s3.amazonaws.com/photos/30240050/medium.jpg\"},\"taxon_changes_count\":1,\"taxon_schemes_count\":3,\"observations_count\":12,\"flag_counts\":{\"resolved\":0,\"unresolved\":0},\"current_synonymous_taxon_ids\":null,\"atlas_id\":null,\"complete_species_count\":null,\"wikipedia_url\":\"http://en.wikipedia.org/wiki/Forbes's_blackbird\",\"complete_rank\":\"subspecies\",\"iconic_taxon_name\":\"Aves\",\"preferred_common_name\":\"Forbes's Blackbird\",\"conservation_status\":{\"id\":65570,\"place_id\":null,\"source_id\":18766,\"user_id\":null,\"authority\":\"IUCN Red List\",\"status\":\"vu\",\"status_name\":\"vulnerable\",\"geoprivacy\":\"obscured\",\"iucn\":30}}},{\"count\":1,\"taxon\":{\"id\":874491,\"rank\":\"species\",\"rank_level\":10,\"iconic_taxon_id\":47126,\"ancestor_ids\":[48460,47126,211194,47125,47124,47123,47122,324170,747312,874725,874491],\"is_active\":true,\"name\":\"Paubrasilia echinata\",\"parent_id\":874725,\"ancestry\":\"48460/47126/211194/47125/47124/47123/47122/324170/747312/874725\",\"extinct\":false,\"default_photo\":{\"id\":26448062,\"license_code\":\"cc-by-nc\",\"attribution\":\"(c) Laurent Quéno, some rights reserved (CC BY-NC), uploaded by Laurent Quéno\",\"url\":\"https://inaturalist-open-data.s3.amazonaws.com/photos/26448062/square.jpeg\",\"original_dimensions\":{\"height\":2048,\"width\":1536},\"flags\":[],\"attribution_name\":\"Laurent Quéno\",\"square_url\":\"https://inaturalist-open-data.s3.amazonaws.com/photos/26448062/square.jpeg\",\"medium_url\":\"https://inaturalist-open-data.s3.amazonaws.com/photos/26448062/medium.jpeg\"},\"taxon_changes_count\":1,\"taxon_schemes_count\":1,\"observations_count\":1232,\"flag_counts\":{\"resolved\":0,\"unresolved\":0},\"current_synonymous_taxon_ids\":null,\"atlas_id\":null,\"complete_species_count\":null,\"wikipedia_url\":\"https://en.wikipedia.org/wiki/Paubrasilia\",\"iconic_taxon_name\":\"Plantae\",\"preferred_common_name\":\"Brazilwood\",\"conservation_status\":{\"id\":158557,\"place_id\":null,\"source_id\":9164,\"user_id\":null,\"authority\":\"IUCN Red List\",\"status\":\"en\",\"status_name\":\"endangered\",\"geoprivacy\":\"obscured\",\"iucn\":40}}}]}"
            )};
            var handler = new MockHttpMessageHandler(mockResponse);
            var client = new HttpClient(handler)
            {
                BaseAddress = new Uri("https://mockapi.test")
            };
            var service = new INaturalistApiClient(client, mockAppSettings);


            // Act
            var result = await service.GetObservations_SpeciesCountsAsync(lat, lng);
            var actualTaxon = result.Where(x => x.taxon.name == expectedName).FirstOrDefault();

            // Assert
            Assert.Equal(result.Count(), expectedCount);
            Assert.Equal(actualTaxon.taxon.name, expectedName);
            Assert.Equal(actualTaxon.taxon.conservation_Status.authority, expectedAuthority);
            Assert.Equal(actualTaxon.taxon.conservation_Status.status, expectedConservationStatusCode);
            Assert.Equal(actualTaxon.taxon.conservation_Status.status_name, expectedConservationStatus);
        }
    }
}
